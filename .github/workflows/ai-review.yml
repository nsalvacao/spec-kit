# =============================================================================
# ü§ñ AI Review ‚Äî inline, no cross-repo reusable dependency
# Uses GitHub Models free tier ‚Äî ZERO premium requests consumed
#
# Configurable via env block at the top of each job:
#   REVIEW_MODEL         ‚Äî primary model for code review       (#77)
#   REVIEW_FALLBACK_MODEL‚Äî fallback model if primary 429s      (#77)
#   SUMMARY_MODEL        ‚Äî primary model for PR summary        (#77)
#   SUMMARY_FALLBACK_MODEL‚Äî fallback model if primary 429s     (#77)
#   MAX_REVIEW_CHARS     ‚Äî max diff chars for review           (#76)
#   MAX_SUMMARY_CHARS    ‚Äî max diff chars for summary          (#76)
#   MAX_RETRY            ‚Äî retry attempts per model            (#77)
# =============================================================================
name: AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**"
      - "tests/**"
      - "scripts/**"
      - "templates/**"
      - ".github/workflows/**"
      - "pyproject.toml"
      - "uv.lock"

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Skip review for PRs labelled 'skip-ai-review' (#76)
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip-ai-review') }}
    env:
      REVIEW_MODEL: "openai/gpt-4.1"
      REVIEW_FALLBACK_MODEL: "openai/gpt-4o"
      MAX_REVIEW_CHARS: "20000"
      MAX_REVIEW_TOKENS: "2000"
      MAX_RETRY: "5"
      MAX_RETRY_SLEEP: "60"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          set -euo pipefail
          git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} > diff_full.txt
          DIFF_SIZE=$(wc -c < diff_full.txt)
          echo "full_size=$DIFF_SIZE" >> "$GITHUB_OUTPUT"

          if [ "$DIFF_SIZE" -gt "$MAX_REVIEW_CHARS" ]; then
            head -c "$MAX_REVIEW_CHARS" diff_full.txt > diff.txt
            echo "truncated=true" >> "$GITHUB_OUTPUT"
            echo "truncated_at=$MAX_REVIEW_CHARS" >> "$GITHUB_OUTPUT"
          else
            cp diff_full.txt diff.txt
            echo "truncated=false" >> "$GITHUB_OUTPUT"
            echo "truncated_at=0" >> "$GITHUB_OUTPUT"
          fi

          if [ ! -s diff.txt ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: AI Review via GitHub Models (with retry)
        if: steps.diff.outputs.skip != 'true'
        id: review
        env:
          GH_MODELS_TOKEN: ${{ secrets.MODELS_PAT }}
        run: |
          set -euo pipefail
          # Mask token to prevent accidental log exposure
          echo "::add-mask::$GH_MODELS_TOKEN"

          SYSTEM_PROMPT="You are a senior code reviewer. Review this diff for: 1) Security vulnerabilities 2) Bugs 3) Best practice violations. Use markdown with severity: üî¥ Critical, üü° Warning, üîµ Info. Be concise but thorough."
          DIFF_CONTENT=$(cat diff.txt)

          # Model fallback chain: primary ‚Üí fallback on rate-limit exhaustion (#77)
          MODELS=("$REVIEW_MODEL" "$REVIEW_FALLBACK_MODEL")
          HTTP_CODE=""
          BODY=""
          USED_MODEL=""

          for MODEL in "${MODELS[@]}"; do
            echo "Trying model: $MODEL"
            ATTEMPT=0
            while [ "$ATTEMPT" -lt "$MAX_RETRY" ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_RETRY with $MODEL..."

              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://models.github.ai/inference/chat/completions" \
                -H "Authorization: Bearer $GH_MODELS_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$(jq -n \
                  --arg system "$SYSTEM_PROMPT" \
                  --arg diff "$DIFF_CONTENT" \
                  --arg model "$MODEL" \
                  --argjson max_tokens "$MAX_REVIEW_TOKENS" \
                  '{
                    model: $model,
                    messages: [
                      {role: "system", content: $system},
                      {role: "user", content: ("Review this pull request diff:\n\n" + $diff)}
                    ],
                    max_tokens: $max_tokens,
                    temperature: 0.2
                  }')")

              HTTP_CODE=$(echo "$RESPONSE" | tail -1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                USED_MODEL="$MODEL"
                break 2
              fi

              echo "::warning::Attempt $ATTEMPT failed (HTTP $HTTP_CODE) with $MODEL"
              if [ "$ATTEMPT" -lt "$MAX_RETRY" ]; then
                RETRY_AFTER=$(echo "$BODY" | jq -r '.retry_after // empty' 2>/dev/null || true)
                if [ -n "$RETRY_AFTER" ]; then
                  SLEEP="$RETRY_AFTER"
                else
                  RAW_SLEEP=$((2 ** ATTEMPT))
                  SLEEP=$(( RAW_SLEEP < MAX_RETRY_SLEEP ? RAW_SLEEP : MAX_RETRY_SLEEP ))
                fi
                JITTER=$((RANDOM % 5))
                SLEEP=$((SLEEP + JITTER))
                echo "Retrying in ${SLEEP}s..."
                sleep "$SLEEP"
              fi
            done

            if [ "$HTTP_CODE" != "200" ]; then
              echo "::warning::All $MAX_RETRY attempts exhausted for $MODEL (HTTP $HTTP_CODE); trying next model..."
            fi
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::All models failed after exhausting retries. Last HTTP $HTTP_CODE"
            echo "$BODY" | jq .error 2>/dev/null || true
            exit 1
          fi

          # Validate output is non-empty and starts with a markdown heading (#77)
          REVIEW_TEXT=$(echo "$BODY" | jq -r '.choices[0].message.content')
          if [ -z "$REVIEW_TEXT" ] || ! echo "$REVIEW_TEXT" | grep -qE '^#|^\*\*|^##'; then
            echo "::warning::Model returned empty or non-markdown response; posting raw output"
          fi

          echo "$REVIEW_TEXT" > review.md
          echo "tokens=$(echo "$BODY" | jq '.usage.total_tokens')" >> "$GITHUB_OUTPUT"
          echo "model=$USED_MODEL" >> "$GITHUB_OUTPUT"

      - name: Post review comment
        if: steps.diff.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            const truncated = '${{ steps.diff.outputs.truncated }}' === 'true';
            const truncatedAt = '${{ steps.diff.outputs.truncated_at }}';
            const tokens = '${{ steps.review.outputs.tokens }}';
            const model = '${{ steps.review.outputs.model }}';

            let footer = `\n\n---\n*ü§ñ AI Review ¬∑ ${model} ¬∑ ${tokens} tokens ¬∑ GitHub Models free tier ¬∑ 0 premium requests*`;
            if (truncated) {
              footer += `\n\n> ‚ö†Ô∏è **Diff truncated** to ${truncatedAt} chars (full diff: ${{ steps.diff.outputs.full_size }} chars). Changes beyond this point were **not reviewed**. Add label \`skip-ai-review\` to suppress, or split the PR.`;
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## üîç AI Code Review\n\n${review}${footer}`
            });

      - name: Skip notice
        if: steps.diff.outputs.skip == 'true'
        run: echo "::notice::No diff detected ‚Äî skipping AI review"

  pr-summary:
    name: AI PR Summary
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip-ai-review') }}
    env:
      SUMMARY_MODEL: "openai/gpt-4.1-mini"
      SUMMARY_FALLBACK_MODEL: "openai/gpt-4o-mini"
      MAX_SUMMARY_CHARS: "12000"
      MAX_SUMMARY_TOKENS: "1000"
      MAX_RETRY: "5"
      MAX_RETRY_SLEEP: "60"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: info
        run: |
          set -euo pipefail
          git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} > diff_full.txt
          head -c "$MAX_SUMMARY_CHARS" diff_full.txt > diff.txt
          git diff --name-status ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} > files.txt

          if [ ! -s diff.txt ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate summary (with retry)
        if: steps.info.outputs.skip != 'true'
        id: summary
        env:
          GH_MODELS_TOKEN: ${{ secrets.MODELS_PAT }}
        run: |
          set -euo pipefail
          # Mask token to prevent accidental log exposure
          echo "::add-mask::$GH_MODELS_TOKEN"

          SYSTEM="Generate a concise PR summary in markdown. Include: ## Summary (1-2 sentences), ## Changes (list key changes), ## Impact (what's affected). Be concise."
          FILES=$(cat files.txt)
          DIFF=$(cat diff.txt)

          # Model fallback chain: primary ‚Üí fallback on rate-limit exhaustion (#77)
          MODELS=("$SUMMARY_MODEL" "$SUMMARY_FALLBACK_MODEL")
          HTTP_CODE=""
          BODY=""
          USED_MODEL=""

          for MODEL in "${MODELS[@]}"; do
            echo "Trying model: $MODEL"
            ATTEMPT=0
            while [ "$ATTEMPT" -lt "$MAX_RETRY" ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_RETRY with $MODEL..."

              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://models.github.ai/inference/chat/completions" \
                -H "Authorization: Bearer $GH_MODELS_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$(jq -n \
                  --arg system "$SYSTEM" \
                  --arg files "$FILES" \
                  --arg diff "$DIFF" \
                  --arg model "$MODEL" \
                  --argjson max_tokens "$MAX_SUMMARY_TOKENS" \
                  '{
                    model: $model,
                    messages: [
                      {role: "system", content: $system},
                      {role: "user", content: ("Files changed:\n" + $files + "\n\nDiff:\n" + $diff)}
                    ],
                    max_tokens: $max_tokens,
                    temperature: 0.3
                  }')")

              HTTP_CODE=$(echo "$RESPONSE" | tail -1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                USED_MODEL="$MODEL"
                break 2
              fi

              echo "::warning::Attempt $ATTEMPT failed (HTTP $HTTP_CODE) with $MODEL"
              if [ "$ATTEMPT" -lt "$MAX_RETRY" ]; then
                RETRY_AFTER=$(echo "$BODY" | jq -r '.retry_after // empty' 2>/dev/null || true)
                if [ -n "$RETRY_AFTER" ]; then
                  SLEEP="$RETRY_AFTER"
                else
                  RAW_SLEEP=$((2 ** ATTEMPT))
                  SLEEP=$(( RAW_SLEEP < MAX_RETRY_SLEEP ? RAW_SLEEP : MAX_RETRY_SLEEP ))
                fi
                JITTER=$((RANDOM % 5))
                SLEEP=$((SLEEP + JITTER))
                echo "Retrying in ${SLEEP}s..."
                sleep "$SLEEP"
              fi
            done

            if [ "$HTTP_CODE" != "200" ]; then
              echo "::warning::All $MAX_RETRY attempts exhausted for $MODEL (HTTP $HTTP_CODE); trying next model..."
            fi
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::All models failed after exhausting retries. Last HTTP $HTTP_CODE"
            echo "$BODY" | jq .error 2>/dev/null || true
            exit 1
          fi

          echo "$BODY" | jq -r '.choices[0].message.content' > summary.md
          echo "model=$USED_MODEL" >> "$GITHUB_OUTPUT"

      - name: Post summary
        if: steps.info.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            const model = '${{ steps.summary.outputs.model }}';
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## üìù AI PR Summary\n\n${summary}\n\n---\n*ü§ñ Auto-generated ¬∑ ${model} ¬∑ GitHub Models free tier ¬∑ 0 premium requests*`
            });
