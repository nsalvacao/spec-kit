# =============================================================================
# ğŸ¤– AI Review â€” inline, no cross-repo reusable dependency
# Uses GitHub Models free tier â€” ZERO premium requests consumed
# =============================================================================
name: AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**"
      - "tests/**"
      - "scripts/**"
      - "templates/**"
      - ".github/workflows/**"
      - "pyproject.toml"
      - "uv.lock"

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} > diff_full.txt
          DIFF_SIZE=$(wc -c < diff_full.txt)
          echo "full_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

          MAX=8000
          if [ "$DIFF_SIZE" -gt "$MAX" ]; then
            head -c "$MAX" diff_full.txt > diff.txt
            echo "truncated=true" >> $GITHUB_OUTPUT
          else
            cp diff_full.txt diff.txt
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi

          if [ ! -s diff.txt ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Review via GitHub Models
        if: steps.diff.outputs.skip != 'true'
        id: review
        env:
          GH_MODELS_TOKEN: ${{ secrets.MODELS_PAT }}
        run: |
          SYSTEM_PROMPT="You are a senior code reviewer. Review this diff for: 1) Security vulnerabilities 2) Bugs 3) Best practice violations. Use markdown with severity: ğŸ”´ Critical, ğŸŸ¡ Warning, ğŸ”µ Info. Be concise but thorough."
          DIFF_CONTENT=$(cat diff.txt)

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://models.github.ai/inference/chat/completions" \
            -H "Authorization: Bearer $GH_MODELS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg diff "$DIFF_CONTENT" \
              '{
                model: "openai/gpt-4.1",
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: ("Review this pull request diff:\n\n" + $diff)}
                ],
                max_tokens: 1500,
                temperature: 0.2
              }')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Models API returned HTTP $HTTP_CODE"
            echo "$BODY" | jq .error 2>/dev/null || echo "$BODY"
            exit 1
          fi

          echo "$BODY" | jq -r '.choices[0].message.content' > review.md
          echo "tokens=$(echo "$BODY" | jq '.usage.total_tokens')" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.diff.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            const truncated = '${{ steps.diff.outputs.truncated }}' === 'true';
            const tokens = '${{ steps.review.outputs.tokens }}';

            let footer = `\n\n---\n*ğŸ¤– AI Review Â· openai/gpt-4.1 Â· ${tokens} tokens Â· GitHub Models free tier Â· 0 premium requests*`;
            if (truncated) {
              footer += `\nâš ï¸ Diff truncated to 8000 chars`;
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## ğŸ” AI Code Review\n\n${review}${footer}`
            });

      - name: Skip notice
        if: steps.diff.outputs.skip == 'true'
        run: echo "::notice::No diff detected â€” skipping AI review"

  pr-summary:
    name: AI PR Summary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: info
        run: |
          git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} > diff_full.txt
          head -c 6000 diff_full.txt > diff.txt
          git diff --name-status ${{ github.event.pull_request.base.sha }}...${{ github.sha }} > files.txt

          if [ ! -s diff.txt ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate summary
        if: steps.info.outputs.skip != 'true'
        env:
          GH_MODELS_TOKEN: ${{ secrets.MODELS_PAT }}
        run: |
          SYSTEM="Generate a concise PR summary in markdown. Include: ## Summary (1-2 sentences), ## Changes (list key changes), ## Impact (what's affected). Be concise."
          FILES=$(cat files.txt)
          DIFF=$(cat diff.txt)

          curl -s -X POST \
            "https://models.github.ai/inference/chat/completions" \
            -H "Authorization: Bearer $GH_MODELS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg system "$SYSTEM" \
              --arg files "$FILES" \
              --arg diff "$DIFF" \
              '{
                model: "openai/gpt-4.1-mini",
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: ("Files changed:\n" + $files + "\n\nDiff:\n" + $diff)}
                ],
                max_tokens: 800,
                temperature: 0.3
              }')" | jq -r '.choices[0].message.content' > summary.md

      - name: Post summary
        if: steps.info.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“ AI PR Summary\n\n${summary}\n\n---\n*ğŸ¤– Auto-generated Â· openai/gpt-4.1-mini Â· GitHub Models free tier Â· 0 premium requests*`
            });
